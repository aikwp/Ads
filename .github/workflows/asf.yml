name: Build FULL Boost for Termux (.deb)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      BOOST_VERSION: 1.85.0
      ANDROID_NDK_VERSION: r26d
      ANDROID_API: 24
      TERMUX_PREFIX: /data/data/com.termux/files/usr

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            python3 \
            wget \
            unzip \
            cmake \
            dpkg-dev \
            fakeroot

      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip
          unzip android-ndk-${ANDROID_NDK_VERSION}-linux.zip
          mv android-ndk-${ANDROID_NDK_VERSION} $HOME/android-ndk

      - name: Download Boost
        run: |
          BOOST_VER=${BOOST_VERSION//./_}
          wget https://boostorg.jfrog.io/artifactory/main/release/${BOOST_VERSION}/source/boost_${BOOST_VER}.tar.gz
          tar xf boost_${BOOST_VER}.tar.gz
          mv boost_${BOOST_VER} boost

      - name: Bootstrap Boost
        run: |
          cd boost
          ./bootstrap.sh

      - name: Create toolchain config
        run: |
          cat > boost/user-config.jam <<EOF
          using clang : android
            : $HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}-clang++
            :
            <archiver>$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
            <ranlib>$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib
            ;
          EOF

      - name: Build FULL Boost into Termux layout
        run: |
          cd boost
          ./b2 \
            -j$(nproc) \
            toolset=clang-android \
            target-os=android \
            architecture=arm \
            address-model=64 \
            binary-format=elf \
            abi=aapcs \
            threading=multi \
            link=static,shared \
            runtime-link=static \
            variant=release \
            cxxflags="-std=c++23 -O3 -fPIC" \
            --user-config=./user-config.jam \
            --prefix=$GITHUB_WORKSPACE/pkgroot${TERMUX_PREFIX} \
            install

      - name: Create DEBIAN control files
        run: |
          mkdir -p pkgroot/DEBIAN

          cat > pkgroot/DEBIAN/control <<EOF
          Package: boost-full
          Version: ${BOOST_VERSION}
          Section: devel
          Priority: optional
          Architecture: aarch64
          Maintainer: zrsx <zrsx@termux>
          Description: Full Boost C++ Libraries for Termux (Android aarch64)
           Built with Android NDK. Installs to Termux prefix.
          EOF

      - name: Strip binaries (size reduction)
        run: |
          find pkgroot -name "*.so*" -exec $HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip {} \; || true
          find pkgroot -name "*.a" -exec $HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip -g {} \; || true

      - name: Build .deb package
        run: |
          dpkg-deb --build pkgroot boost-full-termux-aarch64.deb

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: boost-full-termux-aarch64-deb
          path: boost-full-termux-aarch64.deb
          
